apiVersion: tekton.dev/v1beta1
kind: Pipeline
metadata:
  name: pull-request-pipeline
  namespace: ci  
spec:
  params:
  - name: source-repo
    description: A workspace that contains the fetched git repository.    
    type: string
  - name: revision
    description: the revision to sync to
    default: HEAD
    type: string
  workspaces:
  - name: source-folder  
  - name: diff-result


  tasks:

  - name: git-diff
    taskRef:
      name: git-cli
      kind: ClusterTask
    params:
      - name: GIT_SCRIPT
        value: |
          rm -rf repository
          git config --global --add safe.directory /workspace/source 
          git clone $(params.source-repo) repository
          cd repository
          git checkout $(params.revision)
          rm -f git-diff.txt
          git diff --name-only main..$(params.revision) > git-diff.txt

          pwd
          ls -la git-diff.txt
          cat git-diff.txt
    workspaces:
    - name: source
      workspace: source-folder

  - name: argocd-task-diff
    runAfter:
    - git-diff  
    taskRef:
      kind: Task
      name: argocd-task-diff
    params:
    - name: revision
      value: $(params.revision)
    workspaces:
    - name: source
      workspace: source-folder
    - name: diff-result
      workspace: diff-result

  #TODO New task that update the PR with the contento of $(workspaces.diff-result.path)/diff-output.txt
  - name: add-pr-comment
    runAfter:
    - argocd-task-diff
    taskSpec:
      metadata: {}
      steps:
      - name: set-results
        image: registry.access.redhat.com/ubi8/ubi-minimal:8.3
        resources: {}
        # script: |
        #   #!/usr/bin/env bash
        #   cat $(workspaces.diff-result.path)/diff-output.txt 2>/dev/null || { echo 'There are not ArgoCD differences '; }
        script: |
          #!/usr/bin/env bash

          comment_content=$(< $(workspaces.source-folder.path)/repository/git-diff.txt)

          # VARIABLES
          pr_id=40
          access_token=<your-repo-access-token>

          echo "Adding diff to PR's comment: ${comment_content}";
          curl -X POST -H "Authorization: Bearer ${access_token}" \
          -H "Content-Type: application/json" \
          -d '{"content": {"raw": "Diff result: '"${comment_content}"'"}}' \
          "https://api.bitbucket.org/2.0/repositories/telef-testing/repo-testing1/pullrequests/${pr_id}/comments"
      spec: null
    workspaces:
    - name: diff-result
      workspace: diff-result
    - name: source-folder
      workspace: source-folder
---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  namespace: ci
  name: workspace-pvc-diff-result
spec:
  accessModes:
  - ReadWriteOnce
  resources:
    requests:
      storage: 2Gi
---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  namespace: ci
  name: workspace-pvc-source-folder
spec:
  accessModes:
  - ReadWriteOnce
  resources:
    requests:
      storage: 2Gi